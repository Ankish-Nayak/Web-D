<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYTimes API</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>NY Times article search</h1>
    <div class="wrapper">
        <div class="controls">
            <form>
                <p>
                    <label for="search">Enter a SINGLE search term (required): </label>
                    <input type="text" id="search" class="search" required>
                </p>
                <p>
                    <label for="start-date">Enter a start date (format YYYYMMDD): </label>
                    <input type="date" id="start-date" class="start-date" pattern="[0-9]{8}">
                </p>
                <p>
                    <label for="end-date">Enter an end date (format YYYYMMDD): </label>
                    <input type="date" id="end-date" class="end-date" pattern="[0-9]{8}"> 
                </p>
                <p>
                    <button class="submit">Submit search</button>
                </p>
            </form>
        </div>

        <div class="results">
            <nav>
                <button class="prev">Previous 10</button>
                <button class="next">Next 10</button>
            </nav>    
            <section>

            </section>
        </div>
    </div>
    <script>
        const baseURL = "https://api.nytimes.com/svc/search/v2/articlesearch.json"
        const key = "c19eYNZ6lluBig8g0574naseMO1ckmAh";
        let url;

        const searchTerm = document.querySelector('.search');
        const startDate = document.querySelector('.start-date');
        const endDate = document.querySelector('.end-date');
        const searchForm = document.querySelector('form');

        const nextBtn = document.querySelector('.next');
        const prevBtn = document.querySelector('.prev');
        
        const section = document.querySelector('section');
        const nav = document.querySelector('nav');

        nav.style.display = 'none';

        let pageNumber = 0;
        searchForm.addEventListener('submit', submitSearch);
        nextBtn.addEventListener('click', nextPage);
        prevBtn.addEventListener('clic', previousPage);

        function submitSearch(e) {
            pageNumber = 0;
            fetchResults(e);
        }
        
        function fetchResults(e){
            e.preventDefault();

            url = baseURL + '?api-key=' + key + '&page=' + pageNumber + '&q=' + searchTerm.value + '&fq=document_type:("article")';

            if(startDate.value !== ''){
                url += '&begin_date=' + startDate.value;
            }
            if(endDate.value !== ''){
                url += '&end_date=' + endDate.value;    
            }

            fetch(url).then(function(result){
                return result.json();
            }).then(function(json){
                displayResults(json);
            });
        }

        function displayResults(json){
            while(section.firstChild){
                section.removeChild(section.firstChild);
            }

            const articles = json.response.docs;

            if(articles.length === 10){
                nav.style.display = 'block';
            }else{
                nav.style.display = 'none';
            }
            if(articles.length === 0){
                const para = document.querySelector('p');
                para.textContent = 'No results returned.';
                section.appendChild(para);
            }else{
                for(let i = 0; i<articles.length; ++i){
                    const article = document.createElement('article');
                    const heading = document.createElement('h2');
                    const link = document.createElement('a');
                    const img = document.createElement('img');
                    const para1 = document.createElement('p');
                    const para2 = document.createElement('p');
                    const clearfix = document.createElement('div');
                    
                    let current = articles[i];
                    console.log(current);

                    link.href = current.web_url;
                    link.textContent = current.headline.main;
                    para1.textContent = current.snippet;
                    para2.textContent = 'Keywords: ';
                    for(let i = 0; i<current.keywords.length; ++i){
                        const span = document.createElement('span');
                        span.textContent = current.keywords[i].value + ' ';
                        para2.appendChild(span);
                    }
                    if(current.multimedia.length > 0){
                        img.src = 'http://www.nytimes.com/' + current.multimedia[0].url;
                        img.alt = current.headline.main;
                    }
                    clearfix.setAttribute('class','clearfix');

                    article.appendChild(heading);
                    heading.appendChild(link);
                    article.appendChild(img);
                    article.appendChild(para1);
                    article.appendChild(para2);
                    article.appendChild(clearfix);
                    section.appendChild(article);
                }
            }
        } 
        function nextPage(e){
            pageNumber++;
            fetchResults(e);
        }
        
        function previousPage(e){
            if(pageNumber > 0){
                pageNumber--;
            }else{
                return;
            }
            fetchResults(e);
        }
    </script>
</body>
</html>